on:
  push:
    branches:
      - main

jobs:
  create_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Read version number
        id: read_version
        run: echo "::set-output name=version::$(cat version.txt)"

      - name: Check for prerelease file
        id: check_prerelease
        run: |
          if [ -f prerelease ]; then
          echo "::set-output name=prerelease::true"
          else
          echo "::set-output name=prerelease::false"
          fi
      
      - name: Generate changelog
        id: generate_changelog
        run: |
          if [ -f MOST_RECENT_CHANGELOG ]; then
          echo "::set-output name=changelog::$(cat MOST_RECENT_CHANGELOG)"
          else
          echo "::set-output name=changelog::No changelog found"
          fi

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.read_version.outputs.version }}
          release_name: Release ${{ steps.read_version.outputs.version }}
          prerelease: ${{ steps.check_prerelease.outputs.prerelease }}
          body: ${{ steps.generate_changelog.outputs.changelog }}
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.13'
          architecture: 'x64'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      - name: Build project
        uses: Nuitka/Nuitka-Action@main
        with:
            nuitka-version: 'factory'
            script-name: 'run.py'
            mode: 'standalone'
      # Zip the output folder
      - name: Archive build output
        run: |
          $version = Get-Content version.txt
          $outputDir = "dist"
          $zipFile = "Clarity-$version-windows.zip"
          Compress-Archive -Path "run.build\*" -DestinationPath $zipFile
        shell: powershell
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: Clarity-$version-windows.zip
          asset_name: Clarity-$version-windows.zip
          asset_content_type: application/zip